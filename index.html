<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login</title>
  <link rel="stylesheet" href="styles/index.css">
</head>


<body>
  <div class="login-container">
    <h2>Login</h2>
    <form id="loginForm">
      <div class="input-group">
        <label for="email">Email</label>
        <input type="email" id="email" required />
      </div>
      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" required />
        <span id="togglePassword">ðŸ‘€</span>
      </div>
      <button type="submit">Login</button>
    </form>
    <p id="error" class="error-msg"></p>
    <div class="link">
      Don't have an account? <a href="register.html">Register here</a>
    </div>
    <div class="link">
      <a href="#" id="forgotPasswordLink">Forgot Password?</a>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="forgotPasswordModal">
    <div class="modal-content">
      <h3>Reset Password</h3>
      <p style="font-size:0.9rem; margin-bottom:1rem;">Enter your email to receive reset link</p>
      <input type="email" id="resetEmail" placeholder="Your email">
      <br>
      <button id="sendResetBtn">Send Reset Email</button>
      <br>
      <button id="closeResetBtn">Cancel</button>
    </div>
  </div>



  <script type="module">
    import { auth, db } from './firebaseConfig.js';

    import { ref, get } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail }
      from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";


    const togglePassword = document.getElementById("togglePassword");
    const passwordInput = document.getElementById("password");
    togglePassword.addEventListener("click", () => {
      const type = passwordInput.type === "password" ? "text" : "password";
      passwordInput.type = type;
      togglePassword.textContent = type === "password" ? "ðŸ‘€" : "ðŸ«£";
    });

    const form = document.getElementById("loginForm");
    const errorDisplay = document.getElementById("error");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const password = passwordInput.value.trim();

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Admin redirect condition
        if (email.toLowerCase() === "mmusite123@gmail.com") {
          window.location.href = "admin_home.html";
          return;
        }

        const userRef = ref(db, `users/${user.uid}`);
        const snap = await get(userRef);

        if (!snap.exists()) {
          window.location.href = "profile-setup.html";
        } else {
          window.location.href = "home.html";
        }

      } catch (error) {
        if (error.code === "auth/user-not-found" || error.code === "auth/wrong-password") {
          errorDisplay.textContent = "Invalid email or password.";
        } else {
          errorDisplay.textContent = "Error: " + error.message;
        }
      }
    });

    // Forgot Password
    const forgotPasswordLink = document.getElementById("forgotPasswordLink");
    const forgotPasswordModal = document.getElementById("forgotPasswordModal");
    const sendResetBtn = document.getElementById("sendResetBtn");
    const closeResetBtn = document.getElementById("closeResetBtn");
    const resetEmailInput = document.getElementById("resetEmail");

    forgotPasswordLink.addEventListener("click", (e) => {
      e.preventDefault();
      forgotPasswordModal.style.display = "flex";
    });

    closeResetBtn.addEventListener("click", () => {
      forgotPasswordModal.style.display = "none";
    });

    sendResetBtn.addEventListener("click", async () => {
      const email = resetEmailInput.value.trim();
      if (!email) {
        alert("Please enter your email.");
        return;
      }

      try {
        await sendPasswordResetEmail(auth, email);
        alert("Password reset email sent. Please check your inbox.");
        forgotPasswordModal.style.display = "none";
      } catch (error) {
        alert("Error sending reset email: " + error.message);
      }
    });
  </script>

</body>

</html>